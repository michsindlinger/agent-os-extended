---
name: security-vulnerability-scanner
description: Identifies security vulnerabilities and recommends fixes
version: 1.0
---

# Security Vulnerability Scanner

Identifies security vulnerabilities in code, dependencies, and configurations, providing remediation guidance following OWASP guidelines.

## Trigger Conditions

```yaml
task_mentions:
  - "security|vulnerability|cve"
  - "audit|scan|penetration"
  - "owasp|injection|xss"
file_extension:
  - .ts
  - .js
  - .java
  - .py
  - package.json
  - Gemfile
file_contains:
  - "password"
  - "secret"
  - "token"
  - "eval("
  - "dangerouslySetInnerHTML"
always_active: true
```

## When to Load

- Code review security checks
- Dependency audits
- Pre-deployment security reviews
- Incident response

## Core Competencies

### OWASP Top 10 Detection

#### 1. Injection (SQL, NoSQL, OS Command)

```typescript
// ‚ùå VULNERABLE: SQL Injection
const query = `SELECT * FROM users WHERE email = '${email}'`;
db.query(query);

// ‚úÖ SECURE: Parameterized query
const query = 'SELECT * FROM users WHERE email = $1';
db.query(query, [email]);

// ‚ùå VULNERABLE: Command Injection
exec(`ls ${userInput}`);

// ‚úÖ SECURE: Use array arguments
execFile('ls', [sanitizedPath]);
```

#### 2. Broken Authentication

```typescript
// ‚ùå VULNERABLE: Weak password hashing
const hash = crypto.createHash('md5').update(password).digest('hex');

// ‚úÖ SECURE: Use bcrypt or Argon2
const hash = await bcrypt.hash(password, 12);

// ‚ùå VULNERABLE: Session in URL
app.get('/dashboard?session=abc123');

// ‚úÖ SECURE: HTTP-only cookie
res.cookie('session', token, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict'
});
```

#### 3. Sensitive Data Exposure

```typescript
// ‚ùå VULNERABLE: Logging sensitive data
console.log(`User logged in: ${email}, password: ${password}`);

// ‚úÖ SECURE: Redact sensitive fields
console.log(`User logged in: ${email}`);

// ‚ùå VULNERABLE: Exposing stack traces
app.use((err, req, res, next) => {
  res.status(500).json({ error: err.stack });
});

// ‚úÖ SECURE: Generic error message
app.use((err, req, res, next) => {
  logger.error(err);
  res.status(500).json({ error: 'Internal server error' });
});
```

#### 4. XML External Entities (XXE)

```typescript
// ‚ùå VULNERABLE: External entity processing enabled
const parser = new XMLParser();
parser.parse(untrustedXml);

// ‚úÖ SECURE: Disable external entities
const parser = new XMLParser({
  allowBooleanAttributes: true,
  ignoreAttributes: false,
  parseAttributeValue: true,
  // Disable external entity processing
  processEntities: false
});
```

#### 5. Broken Access Control

```typescript
// ‚ùå VULNERABLE: No authorization check
app.get('/api/users/:id', async (req, res) => {
  const user = await User.findById(req.params.id);
  res.json(user);
});

// ‚úÖ SECURE: Verify ownership/permission
app.get('/api/users/:id', async (req, res) => {
  const user = await User.findById(req.params.id);
  if (user.id !== req.user.id && !req.user.isAdmin) {
    return res.status(403).json({ error: 'Forbidden' });
  }
  res.json(user);
});
```

#### 6. Security Misconfiguration

```typescript
// ‚ùå VULNERABLE: Debug mode in production
app.set('env', 'development');

// ‚úÖ SECURE: Environment-based configuration
app.set('env', process.env.NODE_ENV || 'production');

// ‚ùå VULNERABLE: CORS allows all origins
app.use(cors({ origin: '*' }));

// ‚úÖ SECURE: Specific origins only
app.use(cors({
  origin: ['https://app.example.com'],
  credentials: true
}));
```

#### 7. Cross-Site Scripting (XSS)

```typescript
// ‚ùå VULNERABLE: Unescaped output
document.innerHTML = userInput;

// ‚úÖ SECURE: Use textContent or sanitize
document.textContent = userInput;
// Or use DOMPurify
document.innerHTML = DOMPurify.sanitize(userInput);

// ‚ùå VULNERABLE (React)
<div dangerouslySetInnerHTML={{ __html: userContent }} />

// ‚úÖ SECURE: Sanitize first
<div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userContent) }} />
```

### Dependency Vulnerability Scanning

```bash
# npm audit
npm audit
npm audit fix

# Snyk
npx snyk test
npx snyk monitor

# OWASP Dependency-Check
dependency-check --project "My App" --scan ./

# GitHub Dependabot (automated)
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
```

### Secret Detection Patterns

```yaml
# Common secret patterns to detect
patterns:
  - name: AWS Access Key
    pattern: 'AKIA[0-9A-Z]{16}'
    severity: critical

  - name: AWS Secret Key
    pattern: '[A-Za-z0-9/+=]{40}'
    context: 'aws_secret|secret_key'
    severity: critical

  - name: GitHub Token
    pattern: 'ghp_[a-zA-Z0-9]{36}'
    severity: critical

  - name: Private Key
    pattern: '-----BEGIN (RSA|EC|DSA|OPENSSH) PRIVATE KEY-----'
    severity: critical

  - name: Generic API Key
    pattern: '(api[_-]?key|apikey)["\s]*[:=]["\s]*[a-zA-Z0-9]{20,}'
    severity: high

  - name: JWT Token
    pattern: 'eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*'
    severity: medium
```

## Best Practices

### Security Headers

```typescript
// Required security headers
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'"],
      fontSrc: ["'self'"],
      objectSrc: ["'none'"],
      frameSrc: ["'none'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  },
  referrerPolicy: { policy: 'strict-origin-when-cross-origin' }
}));
```

### Input Validation

```typescript
import { z } from 'zod';

const userSchema = z.object({
  email: z.string().email().max(255),
  password: z.string().min(8).max(72),
  name: z.string().min(1).max(100).regex(/^[a-zA-Z\s]+$/)
});

// Validate all input
const validated = userSchema.parse(req.body);
```

## Vulnerability Report Template

```markdown
# Security Vulnerability Report

## Summary
| Field | Value |
|-------|-------|
| Vulnerability | [Type] |
| Severity | üî¥ Critical / üü† High / üü° Medium / üü¢ Low |
| CVSS Score | [X.X] |
| CWE | [CWE-XXX] |
| Location | [File:Line] |

## Description
[Detailed description of the vulnerability]

## Impact
[What an attacker could do if exploited]

## Reproduction Steps
1. [Step 1]
2. [Step 2]
3. [Observe vulnerability]

## Proof of Concept
```code
[PoC code if safe to include]
```

## Remediation
[Specific fix recommendation with code example]

## References
- [OWASP Reference](link)
- [CVE Details](link)
```

## Anti-Patterns

| Anti-Pattern | Risk | Solution |
|--------------|------|----------|
| eval() with user input | Code injection | Avoid eval entirely |
| Hardcoded secrets | Credential leak | Use env vars/secrets manager |
| HTTP for sensitive data | Data interception | Enforce HTTPS |
| innerHTML with user data | XSS | Use textContent or sanitize |
| Missing CSRF protection | CSRF attacks | Implement CSRF tokens |

## Checklist

### Code Review
- [ ] No hardcoded secrets
- [ ] Input validation on all endpoints
- [ ] Output encoding/sanitization
- [ ] Parameterized queries
- [ ] Proper error handling (no stack traces)

### Dependencies
- [ ] npm audit clean
- [ ] No known critical CVEs
- [ ] Dependencies up to date
- [ ] Lock file committed

### Configuration
- [ ] Security headers configured
- [ ] CORS properly restricted
- [ ] Debug mode disabled
- [ ] HTTPS enforced

## Integration

### Works With
- architect-security-guardian (design)
- security-hardener (infrastructure)
- test-engineer (security tests)

### Output
- Vulnerability reports
- Remediation recommendations
- Security audit results
- Compliance checklists
